<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>もねもかゲーム（仮）</title>
  <!-- スマホ用表示 -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      background: #ffffff;
      padding: 16px 12px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      max-width: 480px;
      width: 100%;
      box-sizing: border-box;
      text-align: center;
    }
    h1 {
      margin-top: 0;
      font-size: 20px;
    }
    .desc {
      font-size: 13px;
      color: #555;
      margin-bottom: 8px;
    }
    .status {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-top: 4px;
      color: #555;
    }

    /* 画像を入れる箱：高さ固定 → ボタン位置が安定 */
    .face-area {
      margin: 12px 0;
      padding: 4px 0;
      border-radius: 12px;
      border: 1px solid #eee;
      height: 55vh;          /* 画面の55%の高さに固定 */
      max-height: 420px;     /* デカすぎ防止（お好みで調整可） */
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fafafa;
      overflow: hidden;      /* はみ出した画像は隠す */
    }
    .face-area img {
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
      border-radius: 8px;
    }

    /* ラベルは使わないので非表示 */
    .face-label {
      display: none;
    }

    .button-row {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-top: 8px;
    }
    button {
      flex: 1;
      padding: 10px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      background: #eee;
    }
    button.primary {
      background: #007aff;
      color: #fff;
    }
    button.secondary {
      background: #ff2d55;
      color: #fff;
    }
    button:disabled {
      opacity: 0.4;
      cursor: default;
    }

    .result {
      margin-top: 12px;
      padding-top: 8px;
      border-top: 1px solid #eee;
      font-size: 13px;
      text-align: left;
    }
    .result p {
      margin: 3px 0;
    }
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: #f0f0ff;
      color: #333;
      font-size: 11px;
      margin-top: 4px;
    }

    .history {
      margin-top: 8px;
      max-height: 220px;   /* 答え合わせリストの高さ上限 */
      overflow-y: auto;
      padding-top: 4px;
      border-top: 1px dashed #ddd;
      font-size: 12px;
    }
    .history h4 {
      margin: 4px 0 4px;
      font-size: 12px;
    }
    .history ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }
    .history li {
      margin-bottom: 6px;
    }
    .history-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .history-item img {
      max-width: 48px;
      max-height: 48px;
      border-radius: 4px;
      flex-shrink: 0;
    }
    .history-text {
      line-height: 1.3;
    }
    .history-text code {
      font-size: 10px;
      background: #f3f3f3;
      padding: 0 3px;
      border-radius: 3px;
    }

    .small {
      font-size: 11px;
      color: #999;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>もねもかゲーム（仮）</h1>
    <div class="desc">
      画面に出てくる画像を見て、<br>
      <b>「もねタイプ」か「もかタイプ」</b>を瞬時にタップ！
      <br>※ローカル画像を使った個人用お遊び版
    </div>

    <div class="status">
      <div>時間：<span id="timeLeft">30.0</span>s</div>
      <div>スコア：<span id="score">0</span>/<span id="total">0</span></div>
    </div>

    <div class="face-area" id="faceArea">
      タップでスタート
    </div>
    <div class="face-label" id="faceHint"></div>

    <div class="button-row">
      <button id="btnMone" class="primary" disabled>もねタイプ</button>
      <button id="btnMoka" class="secondary" disabled>もかタイプ</button>
    </div>

    <button id="btnStart" style="margin-top: 12px; width: 100%;" class="primary">
      ゲームスタート（30秒）
    </button>

    <div class="result" id="result" style="display:none;">
      <p><b>結果</b></p>
      <p>正解数：<span id="resCorrect">0</span> / <span id="resTotal">0</span></p>
      <p>正答率：<span id="resAccuracy">0</span>%</p>
      <p>平均反応時間：<span id="resAvgTime">0</span> ms</p>
      <p>称号：<span id="resTitle">-</span></p>
      <div class="badge" id="resBadge"></div>
      <div id="resultHistory" class="history"></div>
    </div>

    <div class="small">
      画像は <code>img</code> フォルダ内のファイルを使用しています。<br>
      ※公開用途ではオリジナルキャラや自作素材推奨
    </div>
  </div>

  <script>
    // あなたの画像ファイル一覧に対応した faces 配列
    const faces = [
      // もかタイプ（moca*, moka4）
      { type: "moka", label: "もかタイプ1",  display: "img/moca1.webp"  },
      { type: "moka", label: "もかタイプ2",  display: "img/moca2.webp"  },
      { type: "moka", label: "もかタイプ3",  display: "img/moca3.jpg"   },
      { type: "moka", label: "もかタイプ4",  display: "img/moka4.jpg"   },
      { type: "moka", label: "もかタイプ5",  display: "img/moca5.jpg"   },
      { type: "moka", label: "もかタイプ6",  display: "img/moca6.jpg"   },
      { type: "moka", label: "もかタイプ7",  display: "img/moca6.webp"  },
      { type: "moka", label: "もかタイプ8",  display: "img/moca7.jpg"   },
      { type: "moka", label: "もかタイプ9",  display: "img/moca8.webp"  },
      { type: "moka", label: "もかタイプ10", display: "img/moca9.jpg"   },
      { type: "moka", label: "もかタイプ11", display: "img/moca10.webp" },

      // もねタイプ（mone*）
      { type: "mone", label: "もねタイプ1",  display: "img/mone1.jpg"   },
      { type: "mone", label: "もねタイプ2",  display: "img/mone2.jpg"   },
      { type: "mone", label: "もねタイプ3",  display: "img/mone3.jpg"   },
      { type: "mone", label: "もねタイプ4",  display: "img/mone4.webp"  },
      { type: "mone", label: "もねタイプ5",  display: "img/mone5.avif"  },
      { type: "mone", label: "もねタイプ6",  display: "img/mone6.webp"  },
      { type: "mone", label: "もねタイプ7",  display: "img/mone7.jpg"   },
      { type: "mone", label: "もねタイプ8",  display: "img/mone8.webp"  },
      { type: "mone", label: "もねタイプ9",  display: "img/mone9.jpg"   },
      { type: "mone", label: "もねタイプ10", display: "img/mone10.jpg"  }
    ];

    const TIME_LIMIT_MS = 30000; // 30秒

    const faceArea = document.getElementById("faceArea");
    const btnMone = document.getElementById("btnMone");
    const btnMoka = document.getElementById("btnMoka");
    const btnStart = document.getElementById("btnStart");

    const timeLeftEl = document.getElementById("timeLeft");
    const scoreEl = document.getElementById("score");
    const totalEl = document.getElementById("total");

    const resultBox = document.getElementById("result");
    const resCorrectEl = document.getElementById("resCorrect");
    const resTotalEl = document.getElementById("resTotal");
    const resAccuracyEl = document.getElementById("resAccuracy");
    const resAvgTimeEl = document.getElementById("resAvgTime");
    const resTitleEl = document.getElementById("resTitle");
    const resBadgeEl = document.getElementById("resBadge");
    const resultHistoryEl = document.getElementById("resultHistory");

    let currentFace = null;
    let lastFace = null;        // 直前に出した画像
    let correctCount = 0;
    let totalCount = 0;
    let reactionTimes = [];
    let gameStartTime = 0;
    let lastShowTime = 0;
    let timerId = null;
    let history = [];           // 出題履歴

    function formatTime(ms) {
      return (ms / 1000).toFixed(1);
    }

    // 直前と同じ画像は出さないランダム
    function pickRandomFace() {
      if (faces.length === 0) return null;
      let next = null;
      do {
        next = faces[Math.floor(Math.random() * faces.length)];
      } while (faces.length > 1 && next === lastFace);
      lastFace = next;
      return next;
    }

    function showNewFace() {
      currentFace = pickRandomFace();
      if (!currentFace) return;
      faceArea.innerHTML = "<img src='" + currentFace.display + "' alt=''>";
      lastShowTime = performance.now();
    }

    function updateStatus() {
      scoreEl.textContent = correctCount;
      totalEl.textContent = totalCount;
    }

    // 答え合わせリストを描画
    function renderHistory() {
      if (history.length === 0) {
        resultHistoryEl.innerHTML = "";
        return;
      }

      let html = "<h4>答え合わせ</h4><ul>";
      history.forEach((item, index) => {
        const correctLabel = item.correctType === "mone" ? "もね" : "もか";
        const answerLabel = item.userAnswer === "mone" ? "もね" : "もか";
        const mark = item.isCorrect ? "⭕" : "❌";

        html += `
          <li>
            <div class="history-item">
              <img src="${item.file}" alt="">
              <div class="history-text">
                <div>${index + 1}. 回答：<b>${answerLabel}</b> ／ 正解：<b>${correctLabel}</b> ${mark}</div>
                <div><span style="font-size:10px;">反応時間：${item.reaction}ms</span></div>
                <div><code>${item.file}</code></div>
              </div>
            </div>
          </li>
        `;
      });
      html += "</ul>";
      resultHistoryEl.innerHTML = html;
    }

    function endGame() {
      clearInterval(timerId);
      timerId = null;
      btnMone.disabled = true;
      btnMoka.disabled = true;
      btnStart.disabled = false;

      const accuracy = totalCount === 0 ? 0 : Math.round((correctCount / totalCount) * 100);
      const avgTime = reactionTimes.length === 0
        ? 0
        : Math.round(reactionTimes.reduce((a, b) => a + b, 0) / reactionTimes.length);

      resCorrectEl.textContent = correctCount;
      resTotalEl.textContent = totalCount;
      resAccuracyEl.textContent = accuracy.toString();
      resAvgTimeEl.textContent = avgTime.toString();

      let title = "";
      let badge = "";
      if (accuracy >= 90 && avgTime < 350) {
        title = "神レベル判定士";
        badge = "一瞬で見分ける達人";
      } else if (accuracy >= 80 && avgTime < 500) {
        title = "上級もねもかマスター";
        badge = "かなりのガチ勢";
      } else if (accuracy >= 60) {
        title = "中級もねもかファン";
        badge = "反応速度を鍛えよう";
      } else {
        title = "ビギナー";
        badge = "まずは顔に慣れよう";
      }

      resTitleEl.textContent = title;
      resBadgeEl.textContent = badge;

      // 答え合わせを描画
      renderHistory();

      resultBox.style.display = "block";
    }

    function startGame() {
      correctCount = 0;
      totalCount = 0;
      reactionTimes = [];
      history = [];
      lastFace = null;

      updateStatus();
      resultBox.style.display = "none";
      resultHistoryEl.innerHTML = "";

      btnMone.disabled = false;
      btnMoka.disabled = false;
      btnStart.disabled = true;

      gameStartTime = performance.now();
      lastShowTime = gameStartTime;
      timeLeftEl.textContent = formatTime(TIME_LIMIT_MS);

      showNewFace();

      timerId = setInterval(() => {
        const now = performance.now();
        const elapsed = now - gameStartTime;
        const remaining = Math.max(0, TIME_LIMIT_MS - elapsed);
        timeLeftEl.textContent = formatTime(remaining);

        if (remaining <= 0) {
          endGame();
        }
      }, 50);
    }

    function handleAnswer(answerType) {
      if (!currentFace || !timerId) return;

      const now = performance.now();
      const reaction = now - lastShowTime;
      const rounded = Math.round(reaction);

      // 履歴に記録
      history.push({
        file: currentFace.display,
        correctType: currentFace.type,
        userAnswer: answerType,
        isCorrect: answerType === currentFace.type,
        reaction: rounded
      });

      reactionTimes.push(reaction);

      totalCount++;
      if (answerType === currentFace.type) {
        correctCount++;
      }
      updateStatus();

      showNewFace();
    }

    btnStart.addEventListener("click", startGame);
    faceArea.addEventListener("click", () => {
      if (!timerId) {
        startGame();
      }
    });
    btnMone.addEventListener("click", () => handleAnswer("mone"));
    btnMoka.addEventListener("click", () => handleAnswer("moka"));
  </script>
</body>
</html>
